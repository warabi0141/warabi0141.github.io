# シンプレックス法

線形計画問題の最適解は**実行可能領域の端点に存在する**ということを利用して問題を解く方法。端点を移動しながら最適解を求める。

## 手順

1. LPを基準形にする
2. $c_s>0$となるような$s$を1つ選ぶ。そのような$s$がなければ最適解なので終了
3. $\frac{b_r}{a_{rs}}=\min \{\frac{b_i}{a_{is}}\mid a_{is}>0, 1\le i\le m\}$をみたすような行番号$r$を求める
4. $a_{rs}$でピボット操作をして2に戻る

## 直感的な説明

制約が線形なので、実行可能領域はいくつもの直線（あるいは超平面）で囲まれた**凸多角形になっている事が多い**。非有界だと多角形でないこともあるが、部分的に見れば多角形になっている。
このことをざっくりと検証すると、
$$Ax_1 \le b, \quad Ax_2\le b$$
のようにして実行可能領域の中にある2点$x_1,x_2$を取ってくると
$$x' = tx_1 + (1-t)x_2\;(0\le t \le 1)$$
のように凸結合で、２点間の内分点を考えたとき
$$Ax' = tAx_1+(1-t)Ax_2\le tb+(1-t)b=b$$
となるので$x'$も実行可能領域の中の点になっている。凸結合について閉じているので、**実行可能領域は凸集合である**。さらに、制約が線形なので境界は直線を組み合わせることで構成されているはずである。以上より**実行可能領域は凸多角形になっている**。

さらに、目的関数の値が同じになる**等高線は直線になる**。なぜなら
$$c^Tx = k$$
をみたす$x$が等高線を作るが、これはどう考えても直線であるから。

以上の

- 実行可能領域は凸多角形
- 等高線は直線

ということから、**最適解は端点のいずれかである**とわかる。

## アルゴリズムの説明

### スラック変数の導入

シンプレックス法は端点を移動していくアルゴリズムなので、端点を求める必要がある。これを実現するために**スラック変数**を導入する。
$$\begin{align}x_1 + x_2 &\le 6 \\ x_1 + 3x_2 &\le 12 \\ 2x_1 + x_2 &\le 10\end{align}$$
のようにして制約がある場合、**等号成立からのズレを変数にしてしまうことで等式に変換できる**。つまり
$$\begin{align}x_1+x_2+x_3 &= 6\\ x_1+3x_2+x_4&= 12 \\ 2x_1+x_2+x_5&= 10\end{align}$$
とする。このときの$x_3,x_4,x_5$が**スラック変数**である。これらはズレを意味しているから0を代入することで等号を成立させていくことができる。変数の個数$n$に合わせて、$n$個の直線を連立することになるのが、その$n$個の直線の選び方はいろいろある。その選び方を変数のどれを0にするかで表現できる。

例えば上の例で
$$\begin{align}x_3 &= 6-x_1-x_2 \\ x_4 &= 12 - x_1 - 3x_2 \\ x_5 &= 10 - 2x_1 -x_2\end{align}$$
のように変換する。このとき$x_1,x_2=0$とすると$x_1=0,x_2=0$という2つの直線の交点を求めることに対応する。更に変形して
$$\begin{align}x_1 &= 6-x_3 -x_2 \\ x_4 &= 6 +x_3-2x_2\\x_5&= -2+2x_3+x_2 \end{align}$$
とすると、$x_3,x_2=0$と代入すれば$x_2=0, x_1+x_2=6$という2つの直線の交点を求めることに対応する。

- **非基底変数**：0を代入したやつ。等式にする不等式を指定するやつ
- **基底変数**：指定された直線を動く変数。これらの連立を解くことになる

### 不等式とズレを表す変数

もう一度上の条件を眺める。それぞれの不等式の等号成立条件を考えると次のようになっている。
$$\begin{align}x_1\ge 0 &\Leftrightarrow x_1=0\\ x_2\ge 0 &\Leftrightarrow x_2=0\\x_1+x_2\le6 &\Leftrightarrow x_3=0\\x_1+3x_2\le12 &\Leftrightarrow x_4=0\\2x_1+x_2\le10 &\Leftrightarrow x_5=0\end{align}$$
今回は変数は$x_1,x_2$の2つなので、2つの不等式を選んでその境界にあたる直線の交点を求めることで端点を求められる。だから、**非基底変数を選ぶことは境界の直線を選ぶことに対応している**。
この非基底変数を選んで、右辺に集める操作を**ピボット操作**という。

ピボット操作を、目的関数を増加させるようにしながら繰り返すことで最適値へと移動していく

## 行列を使った記述

LPの基準形は、スラック変数も含めて
$$\begin{align}\max &: c^Tx \\ s.t.&:Ax=b, \;x\ge 0\end{align}$$
となっている。基底変数を$x_B$、非基底変数を$x_N$として
$$Ax=\begin{pmatrix}B & N\end{pmatrix}\begin{pmatrix}x_B \\ x_N\end{pmatrix}=Bx_B+Nx_N=b$$
$$z=c^Tx=\begin{pmatrix}c_B^T & c_N^T\end{pmatrix}\begin{pmatrix}x_B \\ x_N\end{pmatrix}=c_B^Tx_B+c_N^Tx_N$$
と書くことにする。$B$が正則であれば、
$$x_B=B^{-1}b-B^{-1}Nx_N$$
と変形できる。これは基底変数が左辺にある基本的な形になっている。さらに、これを目的関数に代入して
$$z = c_B^TB^{-1}b+(c_N^T-c_B^TB^{-1}N)x_N$$
と変形できる。ここまでが基底解$(x_B,x_N)$に対応する辞書になっている。
$$\overline b = B^{-1}b$$
$$\bar c_N=c_N-N^T(B^{-1})^Tc_B$$
$$\bar N=B^{-1}N$$
を導入すると辞書は
$$z = c_B^T\bar b+\bar c_N^Tx_N$$
$$x_B=\bar b - \bar Nx_N$$
となる。このとき、**$\bar c_N$は非基底変数$x_N$のいずれかの値を1増やしたときに、目的関数がどれだけ増えるのかを意味している**。このことから、$\bar c_N$のことを**被約費用**という。

$\bar c_N\le 0$ならこれ以上改善できないことになり、その解は最適解になる。
そうでないとき、$\bar c_N$の成分が正であるものを選んで改善できる可能性がある。

このように行列で表記するとわかることは、**結局のところ$B^{-1}$と$N$がわかればいいということ**である。これらを更新して行けばいいので、行列演算で計算を進めることも可能である。行列演算は高速に行う工夫が色々となされているので、それを活用することで効率よくシンプレックス法を実行することもできる。

## 巡回

ピボット操作をやみくもにやっていると、同じピボット操作を繰り返してしまう**巡回**に陥る可能性がある。そこで、**Bladeのルール**と呼ばれる規則を守って、一定のルールのもとでピボット操作をすることで巡回を防ぐ。

Bladeのルールでは

- 非基底変数を選択するときは、添字が最も小さいものを選ぶ
- 基底変数を選択するときは、添字が最小のものを選ぶ
とする。ルールは何でもよく、添字が最大のものを選んでも問題ない。とにかく**一定のルールを守ってピボット操作をする**ということが大切。

## 2段階シンプレックス法

**初期辞書が実行不可能であるとき**に、

1. 1段階目のシンプレックス法で、実行可能性を確かめる
2. 実行可能なら、2段階目を行う
とする方法。

### 1段階目：補助問題を作る

実行可能なのかどうかを判定するために
$$\begin{align}\min &: x_a \\ s.t. &: Ax-x_aI\le b, \;x\ge 0,\; x_a\ge 0\end{align}$$
という問題を考える。この時点では**スラック変数は必要ない**ことに注意。（実際にシンプレックス法を実行するときには必要）新たに導入された変数の$x_a$は実行可能領域の境界にある直線をどれだけ動かせば実行可能になるのかを表している。よって、最適解$x_a^*$によって

- $x_a^*>0$なら実行不能（境界を移動させないと実行可能にならないので）
- $x_a^*=0$なら実行可能（境界を動かさなくても実行可能だということ）
と判定できる。$x^*_a=0$なら、**このときの基底解は実行可能である**。

### 2段階目：普通にシンプレックス法

こうして得られた実行可能解を初期辞書として通常のシンプレックス法を実行する。

